<section class="whiteboard-shell" *ngIf="board$ | async as board">
  <header class="toolbar">
    <h3>Board: {{ board.id }}</h3>
    <div class="toolbar-actions">
      <button type="button" (click)="zoomOut()">-</button>
      <button type="button" (click)="resetZoom()">{{ zoomPercent() }}%</button>
      <button type="button" (click)="zoomIn()">+</button>
      <button
        type="button"
        *ngFor="let definition of availableWidgets"
        [disabled]="!boardReady()"
        draggable="true"
        (dragstart)="ui.onWidgetButtonDragStart(definition.type, $event, boardReady())"
        (click)="ui.addWidget(definition.type, boardReady())"
      >
        + {{ definition.name }}
      </button>
    </div>
  </header>
  <p class="error-banner" *ngIf="!boardReady()">
    Board is read-only until data is loaded.
  </p>
  <p class="error-banner" *ngIf="loadError$ | async as loadError">
    Load error: {{ loadError }}
  </p>
  <p class="error-banner" *ngIf="saveError$ | async as saveError">
    Save error: {{ saveError }}
  </p>

  <div class="board-layout">
    <app-widget-canvas
      #canvasRef
      [widgets]="board.widgets"
      [frameOverrides]="frameOverrides"
      [selectedWidgetId]="selectedWidget()?.id ?? null"
      [zoom]="zoom"
      [editable]="boardReady()"
      [zoomIndicatorVisible]="zoomIndicatorVisible"
      [zoomIndicatorX]="zoomIndicatorX"
      [zoomIndicatorY]="zoomIndicatorY"
      (canvasClick)="ui.clearSelection()"
      (canvasWheel)="onCanvasWheel($event)"
      (canvasContextMenu)="ui.closeContextMenu($event)"
      (selectWidget)="ui.selectWidget($event)"
      (openWidgetContextMenu)="ui.openContextMenu($event.widgetId, $event.event, boardReady())"
      (startDrag)="ui.onStartDragRequest($event, board.widgets, boardReady())"
      (startResize)="ui.onStartResizeRequest($event, boardReady())"
      (updateText)="ui.onWidgetTextChange($event, boardReady())"
      (widgetDrop)="ui.onWidgetDrop($event, canvasRef.getCanvasElement(), zoom, boardReady())"
    ></app-widget-canvas>

    <aside class="side-panel">
      <app-layer-list
        [widgets]="board.widgets"
        [selectedWidgetId]="selectedWidget()?.id ?? null"
        [definitions]="availableWidgets"
        (selectWidget)="ui.selectWidget($event)"
        (openContextMenu)="ui.openContextMenu($event.widgetId, $event.event, boardReady())"
        (reorderLayer)="ui.onLayerReorder($event, boardReady())"
      ></app-layer-list>

      <ng-container *ngIf="selectedWidget() as selected; else noSelectedWidget">
        <app-widget-config-panel
          [selectedWidget]="selected"
          [widgetCount]="board.widgets.length"
          [layerPosition]="selectedLayerPosition(board, selected.id)"
          [chartTypes]="chartTypes"
          [definitions]="availableWidgets"
          [editable]="boardReady()"
          (action)="ui.onContextMenuAction({ widgetId: selected.id, action: $event }, boardReady())"
          (updateText)="ui.onWidgetTextChange({ widgetId: selected.id, text: $event }, boardReady())"
          (updateChartType)="ui.updateChartType(selected.id, $event, boardReady())"
          (updateCounterLabel)="ui.updateCounterLabel(selected.id, $event, boardReady())"
          (updateCounterValue)="ui.updateCounterValue(selected.id, $event, boardReady())"
          (imageSelected)="ui.updateImageFromFile(selected.id, $event, boardReady())"
        ></app-widget-config-panel>
      </ng-container>
      <ng-template #noSelectedWidget>
        <app-widget-config-panel
          [widgetCount]="board.widgets.length"
          [layerPosition]="0"
          [chartTypes]="chartTypes"
          [definitions]="availableWidgets"
          [editable]="boardReady()"
        ></app-widget-config-panel>
      </ng-template>
    </aside>
  </div>

  <app-widget-context-menu [menu]="contextMenu" (action)="ui.onContextMenuAction($event, boardReady())"></app-widget-context-menu>
</section>
