<section class="miro-board-shell" *ngIf="board$ | async as board">
  <header class="toolbar">
    <h3>Board: {{ board.id }}</h3>
    <div class="toolbar-actions">
      <button type="button" (click)="zoomOut()">-</button>
      <button type="button" (click)="resetZoom()">{{ zoomPercent() }}%</button>
      <button type="button" (click)="zoomIn()">+</button>
      <button type="button" *ngFor="let definition of availableWidgets; trackBy: trackByWidgetType" (click)="addWidget(definition.type)">
        + {{ definition.name }}
      </button>
    </div>
  </header>

  <div class="board-layout">
    <div #canvasRef class="canvas" (click)="clearSelection()" (wheel)="onCanvasWheel($event)" (contextmenu)="closeContextMenu($event)">
      <div
        *ngIf="zoomIndicatorVisible"
        class="zoom-indicator"
        [style.left.px]="zoomIndicatorX"
        [style.top.px]="zoomIndicatorY"
      >
        {{ zoomPercent() }}%
      </div>
      <div
        class="canvas-scroll-space"
        [style.width.px]="surfaceWidth(board) * zoom"
        [style.height.px]="surfaceHeight(board) * zoom"
      ></div>
      <div
        class="canvas-surface"
        [style.width.px]="surfaceWidth(board)"
        [style.height.px]="surfaceHeight(board)"
        [style.transform]="'scale(' + zoom + ')'"
      >
        <article
          class="widget"
          [class.widget-yellow-box]="w.type === 'text'"
          [class.widget-selected]="isSelected(w.id)"
          *ngFor="let w of board.widgets; trackBy: trackByWidgetId"
          [style.left.px]="frame(w).x"
          [style.top.px]="frame(w).y"
          [style.width.px]="frame(w).width"
          [style.height.px]="frame(w).height"
          (click)="selectWidget(w.id); $event.stopPropagation()"
          (mousedown)="startDragFromSelection(w, $event)"
          (contextmenu)="openWidgetContextMenu(w.id, $event)"
        >
          <div class="widget-content" [ngSwitch]="w.type">
            <div *ngSwitchCase="'text'" class="text-render">{{ textValue(w) }}</div>
            <div *ngSwitchCase="'textarea'" class="text-render">{{ textValue(w) }}</div>
            <div *ngSwitchCase="'chart'" class="chart-widget">
              <p>Chart: {{ chartType(w) }}</p>
            </div>
            <div *ngSwitchCase="'counter'" class="counter-widget">
              <p>{{ counterLabel(w) }}</p>
              <h2>{{ counterValue(w) }}</h2>
            </div>
            <div *ngSwitchCase="'table'" class="table-widget">
              <p>Table widget</p>
            </div>
            <div *ngSwitchCase="'image'" class="image-widget">
              <img *ngIf="imageSrc(w)" [src]="imageSrc(w)" [alt]="imageAlt(w)" />
              <p *ngIf="!imageSrc(w)">No image yet</p>
            </div>
          </div>

          <button type="button" class="resize-handle resize-n" (mousedown)="startResize(w, 'n', $event)"></button>
          <button type="button" class="resize-handle resize-s" (mousedown)="startResize(w, 's', $event)"></button>
          <button type="button" class="resize-handle resize-e" (mousedown)="startResize(w, 'e', $event)"></button>
          <button type="button" class="resize-handle resize-w" (mousedown)="startResize(w, 'w', $event)"></button>
          <button type="button" class="resize-handle resize-ne" (mousedown)="startResize(w, 'ne', $event)"></button>
          <button type="button" class="resize-handle resize-nw" (mousedown)="startResize(w, 'nw', $event)"></button>
          <button type="button" class="resize-handle resize-se" (mousedown)="startResize(w, 'se', $event)"></button>
          <button type="button" class="resize-handle resize-sw" (mousedown)="startResize(w, 'sw', $event)"></button>
        </article>
      </div>
    </div>

    <div
      *ngIf="contextMenu as menu"
      class="context-menu"
      [style.left.px]="menu.x"
      [style.top.px]="menu.y"
      (click)="$event.stopPropagation()"
    >
      <button type="button" (click)="bringToFront(menu.widgetId)">Tout devant</button>
      <button type="button" (click)="bringForward(menu.widgetId)">Avant</button>
      <button type="button" (click)="sendBackward(menu.widgetId)">Arrière</button>
      <button type="button" (click)="sendToBack(menu.widgetId)">Tout derrière</button>
      <button type="button" class="danger-action" (click)="remove(menu.widgetId)">Supprimer</button>
    </div>

    <aside class="side-panel">
      <h4>Layers</h4>
      <div class="layer-list">
        <button
          type="button"
          class="layer-item"
          [class.layer-item-selected]="isSelected(widget.id)"
          *ngFor="let widget of orderedWidgets(board); trackBy: trackByWidgetId"
          (click)="selectWidget(widget.id)"
          (contextmenu)="openWidgetContextMenu(widget.id, $event)"
        >
          <span>{{ widgetName(widget.type) }} · {{ shortId(widget.id) }}</span>
          <span>L{{ layerNumber(board, widget.id) }}</span>
        </button>
      </div>

      <h4>Configuration</h4>
      <ng-container *ngIf="selectedWidget(board) as selected; else noSelection">
        <p class="selected-title">{{ widgetName(selected.type) }}</p>
        <p class="layer-label">Layer {{ selectedLayerPosition(board, selected.id) }} / {{ board.widgets.length }}</p>
        <div class="layer-actions">
          <button type="button" (click)="sendToBack(selected.id)">Tout derrière</button>
          <button type="button" (click)="sendBackward(selected.id)">Arrière</button>
          <button type="button" (click)="bringForward(selected.id)">Avant</button>
          <button type="button" (click)="bringToFront(selected.id)">Tout devant</button>
        </div>
        <button type="button" (click)="remove(selected.id)">Supprimer</button>

        <label *ngIf="selected.type === 'text' || selected.type === 'textarea'" class="control-row">
          Texte
          <textarea [ngModel]="textValue(selected)" (ngModelChange)="updateText(selected.id, $event)"></textarea>
        </label>

        <label *ngIf="selected.type === 'chart'" class="control-row">
          Type
          <select [ngModel]="chartType(selected)" (ngModelChange)="updateChartType(selected.id, $event)">
            <option *ngFor="let type of chartTypes" [value]="type">{{ type }}</option>
          </select>
        </label>

        <label *ngIf="selected.type === 'counter'" class="control-row">
          Label
          <input type="text" [ngModel]="counterLabel(selected)" (ngModelChange)="updateCounterLabel(selected.id, $event)" />
        </label>
        <label *ngIf="selected.type === 'counter'" class="control-row">
          Value
          <input type="number" [ngModel]="counterValue(selected)" (ngModelChange)="updateCounterValue(selected.id, $event)" />
        </label>

        <label *ngIf="selected.type === 'image'" class="control-row">
          Import image
          <input type="file" accept="image/*" (change)="updateImageFromFile(selected.id, $event)" />
        </label>
      </ng-container>
      <ng-template #noSelection>
        <p>Sélectionne un widget pour le configurer.</p>
      </ng-template>
    </aside>
  </div>
</section>
